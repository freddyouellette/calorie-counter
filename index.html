<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="jquery.js"></script>
    <title>H</title>
    <style>
        body {
            text-align:center;
        }
        .counter {
            font-size:100px;
        }
        #messages {
            font-size:20px;
            height:22px;
            display:inline-block;
            padding:5px;
            border-radius:10px;
        }
        #background {
            position:absolute;
            width:100%;
            height:100%;
            z-index:-1;
        }
    </style>
</head>
<body>
<div id="background"></div>
<div id="messages">

</div>

<div id="calories" class="counter">

</div>
<button class="calorie_button">-</button>
<input id='calorie_interval' style="text-align:center;"
       type="text" size="10" value="150" />
<button class="calorie_button">+</button>
<br>

<!--
<div id="caffeine" class="counter">

</div>
<button class="caff_button">-50</button>
<button class="caff_button">-U</button>
<button class="caff_button">U</button>
<button class="caff_button">+50</button>
-->
<div id="water" class="counter">

</div>
<button class="water_button">-</button>
<button class="water_button">+</button>

<br>---<br>

<div id="percent"></div>
<button id="reset">reset</button>
</body>
<script>
    let H;
    const CAL_PER_DAY = 1900;
    const CAL_START = 7;
    const CAL_END = 20;

    const CAFFEINE_PER_DAY = 250; // milligrams
    const CAFF_START = 8;
    const CAFF_END = 16;
    const CAFF_IN_SHOT = 40; // milligrams of caffeine

    const WATER_PER_DAY = 3; // litres
    const WATER_START = 7;
    const WATER_END = 22;
    const LITTLE_DRINK = 35; // millilitres

    function message(string, color='green') {
        $('#messages').clearQueue().finish()
            .html(string).css('background-color', color)
            .fadeTo(0, 1).delay(2000).fadeTo(1000, 0.001);
    }

    class Data {
        constructor() {
            this.day = new Date();
            this.current_calories = 0;
            this.current_water = 0;
            this.current_caffeine = 0;
        }
        save() {
            $.ajax({
                type: "POST",
                url: 'data.php',
                data: {
                    'save': JSON.stringify(this)
                },
                success: function(data) {

                },
                failure: function() {
                    message('not saved.', 'red');
                }
            });
        }
    }

    function percent(starthour, endhour) {
        let now = new Date();
        let nowseconds = now.getHours() * 60 * 60
            + now.getMinutes() * 60 + now.getSeconds()
            + now.getMilliseconds()/1000;
        let p = Math.round((nowseconds - starthour * 60 * 60)*100
                /(endhour * 60 * 60 - starthour * 60 * 60)*1000)/1000;
        if (p < 0) p = 0;
        if (p > 100) p = 100;
        return p;
    }

    function update() {
        if (new Date(H.day).toDateString()
            !== new Date().toDateString()) {
            H.day = new Date();
            H.current_calories = 0;
            H.current_water = 0;
        }

        let cal = $("#calories"), water = $('#water'), per = $('#percent'), caff = $('#caffeine');
        let calories_left = Math.round(
                (Math.round(percent(CAL_START, CAL_END) * CAL_PER_DAY) / 100
                - H.current_calories) * 100 ) / 100;
        calories_left = calories_left.toFixed(2);
        cal.html(calories_left);
        if (calories_left < 0) cal.css('color', 'red');
        else cal.css('color', 'green');

        let water_left = Math.round(Math.round(0 - percent(WATER_START, WATER_END)
                    * (WATER_PER_DAY * 1000))
                + H.current_water * 100) / 100;
        water_left = water_left.toFixed(2);
        water.html(water_left);
        if (water_left < 0) water.css('color', 'red');
        else water.css('color', 'green');
	/*
        let caffeine_left = Math.round(
                (-Math.round(percent(CAFF_START, CAFF_END) * CAFFEINE_PER_DAY) / 100
                + H.current_caffeine) * 100 ) / 100;
        caffeine_left = caffeine_left.toFixed(2);
        caff.html(caffeine_left);
        if (caffeine_left < 0) caff.css('color', 'red');
        else caff.css('color', 'green');
	*/
        per.html((Math.round(percent(CAL_START, CAL_END) * 100) / 100).toFixed(2) + '%');
    }

    $(document).on('ready', function() {
        $.ajax({
            type: 'POST',
            url: 'data.php',
            data: {
                'load': true
            },
            success: function(data) {
                data = JSON.parse(data);
                H = new Data();
                if (data !== 'false') {
                    Object.assign(H, data);
                    message('loaded.', 'green');
                }
                else {
                    message('new session');
                }
                H.save();
            }
        })
    });

    $(document).on('click', '.calorie_button', function() {
        if ($(this).html() === '-') {
            H.current_calories -= parseInt($('#calorie_interval').val());
        }
        else H.current_calories += parseInt($('#calorie_interval').val());
        H.save();
        update();
    });

    $(document).on('click', '.water_button', function() {
        let amount = LITTLE_DRINK;
        if ($(this).html().includes('-')) amount = -amount;
        H.current_water += amount;
        H.save();
        update();
    });

    $(document).on('click', '.caff_button', function() {
        let amount = 50;
        if ($(this).html().includes('U')) amount = CAFF_IN_SHOT;
        if ($(this).html().includes('-')) amount = -amount;
        H.current_caffeine += amount;
        H.save();
        update();
    });

    $(document).on('click', '#reset', function() {
        if (confirm('reset?')) {
            H = new Data();
            H.save();
            message('reset', 'red');
        }
    });

    window.setInterval(function(){
        update();
    }, 3000);
</script>
</html>























