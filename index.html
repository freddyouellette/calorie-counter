<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
	<link rel="apple-touch-icon" href="favicon.ico"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script> window.jQuery || document.write('<script src="jquery.min.js"><\/script>'); </script>
	<title>freddyouellette/calorie-counter</title>
	<style>
		body {
            text-align:center;
			font-size:16px;
        }
		input {
			font-size:16px;
		}
		input[type="text"] {
			width:60px;
		}
        .counter {
            font-size:100px;
        }
        #messages {
            font-size:20px;
            height:22px;
            display:inline-block;
            padding:5px;
            border-radius:10px;
        }
		#github-link {
			text-decoration:none;
			color:rgb(45, 79, 143);
		}
		#github-link:hover {
			text-decoration:underline;
		}
    </style>
</head>

<body>
	<div id="main" style="min-height:100vh;">
		<div id="messages"></div>
		
		<div id="calorie-container">
			<div class="label">Calories:</div>
			<div id="calories" class="counter"></div>
			<div id="calorie-percent"></div>
			<button class="calorie_button">-</button>
			<input id='calorie_interval' style="text-align:center;" type="text" size="10" value="150" />
			<button class="calorie_button">+</button>
		</div>
		<br/>
		
		<div id="caffeine-container">
			<div class="label"><br/>Caffeine (mg):</div>
			<div id="caffeine" class="counter"></div>
			<button class="caff_button">-cup</button>
			<button class="caff_button">-shot</button>
			<button class="caff_button">+shot</button>
			<button class="caff_button">+cup</button>
		</div>
		
		<div id="water-container">
			<div class="label"><br/>Water (mL):</div>
			<div id="water" class="counter">
			</div>
			<button class="water_button">-</button>
			<button class="water_button">+</button>
		</div>
		<br/><br/>
		<div id="day-percent-container">
			<div id="percent"></div>
		</div>
	</div>
	
	<div id="options">
		<div>- - - - - - - - - - - - - - - - - - - - - - - - - -</div>
		<br/>
		<div>
			<input type="checkbox" id="bShowCalories" class="setting" name="bShowCalories"/>
			<label for="bShowCalories">Show Calories</label>
		</div>
		<div>
			<input type="checkbox" id="bShowCaloriePercent" class="setting" name="bShowCaloriePercent"/>
			<label for="bShowCaloriePercent">Show Calorie Amount and Percent</label>
		</div>
		<div>
			<input type="checkbox" id="bShowCaffeine" class="setting" name="bShowCaffeine"/>
			<label for="bShowCaffeine">Show Caffeine</label>
		</div>
		<div>
			<input type="checkbox" id="bShowWater" class="setting" name="bShowWater"/>
			<label for="bShowWater">Show Water</label>
		</div>
		<div>
			<input type="checkbox" id="bShowDayPercent" class="setting" name="bShowDayPercent"/>
			<label for="bShowDayPercent">Show Day Percent</label>
		</div>
		<div>
			<input type="checkbox" id="bShowLabels" class="setting" name="bShowLabels"/>
			<label for="bShowLabels">Show Labels</label>
		</div>
		<div>- - - - - - - - - - - - - - - - - - - - - - - - - -</div>
		<div>
			<label for="intCaloriesPerDay">Calories Per Day:</label>
			<input type="text" id="intCaloriesPerDay" class="setting" name="intCaloriesPerDay"/>
		</div>
		<div>
			<label for="intCalorieStartHour">Starting hour for Calories:</label>
			<input type="text" id="intCalorieStartHour" class="setting" name="intCalorieStartHour"/>
		</div>
		<div>
			<label for="intCalorieEndHour">Ending hour for Calories:</label>
			<input type="text" id="intCalorieEndHour" class="setting" name="intCalorieEndHour"/>
		</div>
		<div>- - - - - - - - - - - - - - - - - - - - - - - - - -</div>
		<div>
			<label for="intCaffeinePerDay">Caffeine Per Day (milligrams):</label>
			<input type="text" id="intCaffeinePerDay" class="setting" name="intCaffeinePerDay"/>
		</div>
		<div>
			<label for="intCaffeineStartHour">Starting hour for Caffeine:</label>
			<input type="text" id="intCaffeineStartHour" class="setting" name="intCaffeineStartHour"/>
		</div>
		<div>
			<label for="intCaffeineEndHour">Ending hour for Caffeine:</label>
			<input type="text" id="intCaffeineEndHour" class="setting" name="intCaffeineEndHour"/>
		</div>
		<div>
			<label for="intCaffeineInShot">Caffeine in shot (milligrams):</label>
			<input type="text" id="intCaffeineInShot" class="setting" name="intCaffeineInShot"/>
		</div>
		<div>
			<label for="intCaffeineInCup">Caffeine in cup (milligrams):</label>
			<input type="text" id="intCaffeineInCup" class="setting" name="intCaffeineInCup"/>
		</div>
		<div>- - - - - - - - - - - - - - - - - - - - - - - - - -</div>
		<div>
			<label for="intWaterPerDay">Water Per Day (litres):</label>
			<input type="text" id="intWaterPerDay" class="setting" name="intWaterPerDay"/>
		</div>
		<div>
			<label for="intWaterStartHour">Starting hour for Water:</label>
			<input type="text" id="intWaterStartHour" class="setting" name="intWaterStartHour"/>
		</div>
		<div>
			<label for="intWaterEndHour">Ending hour for Water:</label>
			<input type="text" id="intWaterEndHour" class="setting" name="intWaterEndHour"/>
		</div>
		<div>
			<label for="intWaterLittleDrink">Water in gulp (millilitres):</label>
			<input type="text" id="intWaterLittleDrink" class="setting" name="intWaterLittleDrink"/>
		</div>
		<div>- - - - - - - - - - - - - - - - - - - - - - - - - -</div>
		<br/>
		<button id="reset">reset</button><br/>
		<br/>
		<div style="font-style:italic;color:gray;">Created by Frederick Ouellette, Houston TX 2018</div>
		<a href="https://github.com/freddyouellette/calorie-counter" target="_blank" rel="noopener noreferrer" id="github-link">GitHub Page</a>
		<div style="height:50px;"></div>
	</div>
<script>
	$(function () {
		var message, 
			overwriteObject, 
			DataStorage, 
			saveSettings, 
			percent, 
			setDefaults, 
			startEventHandlers,
			rerenderSettings, 
			reset, 
			updateSettings, 
			update, 
			handleCalorieButton,
			handleWaterButton,
			handleCaffeineButton;
		
		var settings = {};
		var defaultSettings = {
			day: new Date(),
			current_calories: 0,
			current_water: 0,
			current_caffeine: 0,
			
			// set defaults
			bShowCalories: true,
			bShowLabels: true,
			bShowCaffeine: false,
			bShowWater: true,
			bShowDayPercent: false,
			bShowCaloriePercent: false,
			intIntervalMilliseconds: 1000,
			
			intCaloriesPerDay: 1900,
			intCalorieStartHour: 7,
			intCalorieEndHour: 19,
			
			intCaffeinePerDay: 250,
			intCaffeineStartHour: 7,
			intCaffeineEndHour: 19,
			intCaffeineInShot: 40,
			intCaffeineInCup: 80,
			
			intWaterPerDay: 3,
			intWaterStartHour: 7,
			intWaterEndHour: 19,
			intWaterLittleDrink: 40
		};
		
		message = function(string, color) {
			color = color || 'green';
			$('#messages').clearQueue().finish()
				.html(string).css('background-color', color)
				.fadeTo(0, 1).delay(2000).fadeTo(1000, 0.001);
		}
		
		// polyfill for Object.assign()
		overwriteObject = function(originalObj, newObj) {
			for(var prop in newObj) {
				originalObj[prop] = newObj[prop];
			}
			return originalObj;
		}
		
		DataStorage = (function(storageName) {
			var localStorageManager = {
				save: function(data) {
					localStorage[storageName] = JSON.stringify(data);
				},
				load: function() {
					try {
						var data = JSON.parse(localStorage[storageName]);
						return data;
					} catch(error) {
						message('new session', 'red');
						return {};
					}
				}
			}
			
			var cookieManager = {
				save: function(data) {
					var expiryDate = new Date();
					expiryDate.setHours(0,0,0,0);
					expiryDate.setDate(expiryDate.getDate() + 10); // ten days at 00:00:00
					var cookieExpiry = 'expires=' + expiryDate.toGMTString() + '; ';
					var cookieString = escape(storageName) + '=' + escape(JSON.stringify(data)) + '; ';
					document.cookie = cookieString + cookieExpiry;
				},
				load: function() {
					try {
						var rawCookie = document.cookie.split('; ');
						var cookieData = [];
						for(var index = 0; index < rawCookie.length; index++) {
							if(rawCookie[index].length) {
								var parts = rawCookie[index].split('=');
								cookieData[parts[0]] = parts[1];
							}
						}
						if(cookieData[storageName]) {
							console.log(JSON.parse(unescape(cookieData[storageName])));
							return JSON.parse(unescape(cookieData[storageName]));
						} else {
							return {};
						}
					} catch(error) {
						console.log('cookie validation failed.');
						console.log(error);
						return {};
					};
				}
			}
			
			// test if we have localStorage
			var test = 'localStorageTest';
			try {
				localStorage.setItem(test, test);
				localStorage.removeItem(test);
				return localStorageManager;
			} catch(error) {
				// fall back to using cookies
				return cookieManager;
			}
		})('health');
		
		saveSettings = function() {
			DataStorage.save(settings);
		}
		
		percent = function(starthour, endhour) {
			var now = new Date();
			var nowseconds = now.getHours() * 60 * 60
				+ now.getMinutes() * 60 + now.getSeconds()
				+ now.getMilliseconds() / 1000;
			var p = Math.round((nowseconds - starthour * 60 * 60) * 100
				/ (endhour * 60 * 60 - starthour * 60 * 60) * 1000) / 1000;
			if (p < 0) p = 0;
			if (p > 100) p = 100;
			return p;
		}
		
		setDefaults = function() {
			settings = overwriteObject(settings, defaultSettings);
		}
		
		startEventHandlers = function() {
			$('.calorie_button').click(handleCalorieButton);
			$('.water_button').click(handleWaterButton);
			$('.caff_button').click(handleCaffeineButton);
			$('.setting').change(updateSettings);
			$('#reset').click(reset);
		}
		
		reset = function() {
			if (confirm('reset?')) {
				setDefaults();
				rerenderSettings();
				saveSettings();
				message('reset', 'red');
			}
		}
		
		rerenderSettings = function() {
			$('.setting').each(function(index, setting) {
				if($(setting).prop('type') == 'checkbox') {
					$(setting).prop('checked', settings[$(setting).prop('name')]);
				} else {
					$(setting).val(settings[$(setting).prop('name')]);
				}
			});
		}
		
		updateSettings = function() {
			$('.setting').each(function(index, setting) {
				if($(setting).prop('type') == 'checkbox') {
					settings[$(setting).prop('name')] = $(setting).is(':checked');
				} else {
					settings[$(setting).prop('name')] = $(setting).val();
				}
			});
			saveSettings();
			update();
		}
		
		update = function() {
			if (new Date(settings.day).toDateString()
				!== new Date().toDateString()) {
				settings.day = new Date();
				settings.current_calories = 0;
				settings.current_water = 0;
			}
			
			// calories
			if(settings.bShowCalories) {
				var cal = $("#calories");
				var calories_left = Math.round(
					(Math.round(percent(settings.intCalorieStartHour, settings.intCalorieEndHour) * settings.intCaloriesPerDay) / 100
						- settings.current_calories) * 100) / 100;
				calories_left = calories_left.toFixed(2);
				cal.html(calories_left);
				if (calories_left < 0) cal.css('color', 'red');
				else cal.css('color', 'green');
				$('#calorie-container').show();
			} else {
				$('#calorie-container').hide();
			}
			
			if(settings.bShowCaloriePercent) {
				var flCaloriePercent = Math.round(settings.current_calories / settings.intCaloriesPerDay * 10000) / 100;
				$('#calorie-percent').show().html('('+settings.current_calories+' / '+(settings.intCaloriesPerDay - settings.current_calories)+' | '+flCaloriePercent+'%)<br/><br/>');
			} else {
				$('#calorie-percent').hide();
			}
			
			// water
			if(settings.bShowWater) {
				var water = $('#water');
				var water_left = Math.round(Math.round(0 - percent(settings.intWaterStartHour, settings.intWaterEndHour)
					* (settings.intWaterPerDay * 1000))
					+ settings.current_water * 100) / 100;
				water_left = water_left.toFixed(2);
				water.html(water_left);
				if (water_left < 0) water.css('color', 'red');
				else water.css('color', 'green');
				$('#water-container').show();
			} else {
				$('#water-container').hide();
			}
			
			// caffeine
			var caff = $('#caffeine');
			if(settings.bShowCaffeine) {
				var caffeine_left = Math.round(
						(-Math.round(percent(settings.intCaffeineStartHour, settings.intCaffeineEndHour) * settings.intCaffeinePerDay) / 100
						+ settings.current_caffeine) * 100 ) / 100;
				caffeine_left = caffeine_left.toFixed(2);
				caff.html(caffeine_left);
				if (caffeine_left < 0) caff.css('color', 'red');
				else caff.css('color', 'green');
				$('#caffeine-container').show();
			} else {
				$('#caffeine-container').hide();
			}
			
			// percentage
			if(settings.bShowDayPercent) {
				$('#percent').html((Math.round(percent(settings.intCalorieStartHour, settings.intCalorieEndHour) * 100) / 100).toFixed(2) + '%');
				$('#day-percent-container').show();
			} else {
				$('#day-percent-container').hide();
			}
			
			if(settings.bShowLabels) {
				$('.label').show();
			} else {
				$('.label').hide();
			}
		}
		
		handleCalorieButton = function(event) {
			if ($(event.target).html() === '-') {
				settings.current_calories -= parseInt($('#calorie_interval').val()) || 0;
			}
			else settings.current_calories += parseInt($('#calorie_interval').val()) || 0;
			saveSettings();
			update();
		}
		
		handleWaterButton = function(event) {
			var amount = settings.intWaterLittleDrink;
			if ($(event.target).html().includes('-')) amount = -amount;
			settings.current_water += parseInt(amount) || 0;
			saveSettings();
			update();
		}
		
		handleCaffeineButton = function(event) {
			var amount;
			if ($(event.target).html().includes('shot')) amount = parseInt(settings.intCaffeineInShot) || 0;
			if ($(event.target).html().includes('cup')) amount = parseInt(settings.intCaffeineInCup) || 0;
			if ($(event.target).html().includes('-')) amount = parseInt(-amount) || 0;
			settings.current_caffeine += parseInt(amount);
			saveSettings();
			update();
		}
		
		setDefaults();
		settings = overwriteObject(settings, DataStorage.load());
		
		update();
		saveSettings();
		rerenderSettings();
		startEventHandlers();
		
		setInterval(update, settings.intIntervalMilliseconds);
	});
</script>
</body>
</html>
